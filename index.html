<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supermarket-Globally | Pi Marketplace</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        :root { --p-purp: #4a148c; --p-gold: #ffa000; }
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f4f4f4; margin: 0; }
        header { background: var(--p-purp); color: white; padding: 30px; border-bottom: 5px solid var(--p-gold); }
        .card { background: white; margin: 20px auto; padding: 20px; border-radius: 15px; max-width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn { background: var(--p-gold); border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }
        #status { background: #333; color: var(--p-gold); padding: 10px; font-size: 14px; }
    </style>
</head>
<body>
    <header>
        <h1>SUPERMARKET GLOBALLY</h1>
        <div id="status">Connecting to Pi...</div>
    </header>

    <div class="card">
        <h3>Multi-Vendor Product</h3>
        <p>Zero Listing Fees | Global Delivery</p>
        <h2 style="color: #4a148c;">10.00 Ï€</h2>
        <input type="text" id="cust-name" placeholder="Full Name" style="width:90%; padding:10px; margin:5px;">
        <textarea id="cust-address" placeholder="Delivery Address" style="width:90%; padding:10px; margin:5px;"></textarea>
        <button class="btn" onclick="pay()">BUY NOW WITH PI</button>
    </div>

    <script>
        const Pi = window.Pi;
        Pi.init({ version: "2.0", sandbox: true }); // BADILISHA iwe false ukishamaliza test

        // MUHIMU: Badilisha URL hapa chini uweke ile URL utakayopewa na Render
        const BACKEND_URL = "https://supermarket-globally.onrender.com";

        async function login() {
            try {
                const user = await Pi.authenticate(['username', 'payments'], onIncompletePaymentFound);
                document.getElementById('status').innerText = "Welcome, " + user.user.username;
            } catch (e) {
                document.getElementById('status').innerText = "Please open in Pi Browser";
            }
        }

        async function onIncompletePaymentFound(payment) {
            await fetch(`${BACKEND_URL}/incomplete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ payment })
            });
        }

        async function pay() {
            const name = document.getElementById('cust-name').value;
            const addr = document.getElementById('cust-address').value;
            if(!name || !addr) return alert("Fill all details!");

            Pi.createPayment({
                amount: 10.00,
                memo: "Purchase from Supermarket Globally",
                metadata: { name, addr }
            }, {
                onReadyForServerApproval: (id) => {
                    fetch(`${BACKEND_URL}/approve`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paymentId: id })
                    });
                },
                onReadyForServerCompletion: (id, txid) => {
                    fetch(`${BACKEND_URL}/complete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paymentId: id, txid })
                    });
                },
                onCancel: (id) => { console.log("Cancelled"); },
                onError: (err) => { alert("Error!"); }
            });
        }
        window.onload = login;
    </script>
</body>
</html>
